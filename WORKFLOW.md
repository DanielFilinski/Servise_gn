# 🔄 Рабочий процесс валидации библейских ссылок

## 📋 Трехэтапный процесс

### Этап 1: Валидация и генерация шаблонов

```bash
npm run validate
```

**Что происходит:**
- ✅ Проверяет все ссылки в `SS+.json`
- ✅ Находит пропущенные и некорректные ссылки
- ✅ Автоматически генерирует шаблоны исправлений
- ✅ Сохраняет шаблоны в `bibleLinksCorrections.json`
- ❌ НЕ изменяет файлы (только анализ)

**Результат:**
```
📊 СТАТИСТИКА ВАЛИДАЦИИ
   Всего проблем: 36
   
✅ Добавлено 36 новых шаблонов в bibleLinksCorrections.json
```

---

### Этап 2: Ручное редактирование исправлений

Откройте `bibleLinksCorrections.json` и отредактируйте сгенерированные шаблоны:

#### Пример шаблона (автоматически созданного):

```json
{
  "from": "1) «перейти» (Нав. 1:1–5:12);",
  "info": {
    "lessonId": 3,
    "date": "2025-09-29 00:00:00.000",
    "lessonName": "Перейди! Возьми! Раздели! Служи!",
    "lessonNumber": 1,
    "contentId": 11,
    "contentType": "question"
  },
  "links": [
    {
      "text": "Нав. 1:1–5:12",
      "data": [
        {
          "bookNumber": 60,
          "chapter": [1],
          "verses": [7]
        }
      ]
    }
  ],
  "autoApply": false
}
```

#### Отредактируйте:

1. **Исправьте данные ссылки**:
   - Для диапазона глав 1-5: `"chapter": [1, 2, 3, 4, 5]`
   - Для всей главы: `"verses": null`

2. **Установите autoApply**:
   - `"autoApply": true` - применить автоматически
   - `"autoApply": false` - пропустить

#### Правильное исправление:

```json
{
  "from": "1) «перейти» (Нав. 1:1–5:12);",
  "info": {
    "lessonId": 3,
    "date": "2025-09-29 00:00:00.000",
    "lessonName": "Перейди! Возьми! Раздели! Служи!",
    "lessonNumber": 1,
    "contentId": 11,
    "contentType": "question"
  },
  "links": [
    {
      "text": "Нав. 1:1–5:12",
      "data": [
        {
          "bookNumber": 60,
          "chapter": [1, 2, 3, 4, 5],
          "verses": null
        }
      ]
    }
  ],
  "autoApply": true
}
```

---

### Этап 3: Применение исправлений

```bash
npm run apply
```

**Что происходит:**
- ✅ Загружает `SS+.json`
- ✅ Применяет только исправления с `autoApply: true`
- ✅ Создает `SS-valid.json` с исправлениями
- ✅ Показывает статистику оставшихся проблем

**Результат:**
```
🔧 Найдено исправлений для применения: 1

✅ Применено: Урок 1, Content ID 11
✅ Результат сохранен в ./ResultParse/SS/SS-valid.json

✅ Применено исправлений: 1

📊 СТАТИСТИКА ВАЛИДАЦИИ
   Всего проблем: 35
   
⚠️  Осталось проблем: 35
💡 Запустите npm run validate для обновления списка
```

---

## 🔄 Полный цикл

```bash
# 1. Парсинг HTML
npm run ss

# 2. Валидация (генерация шаблонов)
npm run validate

# 3. Редактирование bibleLinksCorrections.json
#    - Исправьте данные ссылок
#    - Установите autoApply: true

# 4. Применение исправлений
npm run apply

# 5. Повторная валидация (проверка оставшихся проблем)
npm run validate
```

---

## 📊 Диаграмма процесса

```
┌─────────────┐
│  HTML файлы │
└──────┬──────┘
       │
       ▼
  npm run ss
       │
       ▼
┌─────────────────┐
│  SS+.json       │  ← Оригинальный результат
└────────┬────────┘
         │
         ▼
   npm run validate  ← ШАГ 1: Анализ
         │
         ▼
┌───────────────────────┐
│ bibleLinksCorrections │  ← Автоматические шаблоны
│ autoApply: false      │
└──────────┬────────────┘
           │
           ▼
   Ручное редактирование  ← ШАГ 2: Проверка и правка
           │
           ▼
┌───────────────────────┐
│ bibleLinksCorrections │  ← Проверенные исправления
│ autoApply: true       │
└──────────┬────────────┘
           │
           ▼
      npm run apply  ← ШАГ 3: Применение
           │
           ▼
┌─────────────────┐
│  SS-valid.json  │  ← Финальный результат
└─────────────────┘
```

---

## 💡 Примеры исправлений

### Диапазон глав (1-5)

```json
{
  "text": "Нав. 1:1–5:12",
  "data": [{
    "bookNumber": 60,
    "chapter": [1, 2, 3, 4, 5],
    "verses": null
  }]
}
```

### Диапазон стихов (7-9)

```json
{
  "text": "Нав. 1:7-9",
  "data": [{
    "bookNumber": 60,
    "chapter": [1],
    "verses": [7, 8, 9]
  }]
}
```

### Одна ссылка

```json
{
  "text": "Нав. 1:7",
  "data": [{
    "bookNumber": 60,
    "chapter": [1],
    "verses": [7]
  }]
}
```

### Множественные ссылки

```json
{
  "links": [
    {
      "text": "Быт. 1:1",
      "data": [{
        "bookNumber": 10,
        "chapter": [1],
        "verses": [1]
      }]
    },
    {
      "text": "Ин. 3:16",
      "data": [{
        "bookNumber": 500,
        "chapter": [3],
        "verses": [16]
      }]
    }
  ]
}
```

---

## 🎯 Преимущества нового подхода

| Старый подход | Новый подход |
|---------------|--------------|
| ❌ Автоматические исправления без проверки | ✅ Ручная проверка перед применением |
| ❌ Риск неправильных исправлений | ✅ Контроль качества |
| ❌ Сложно откатить изменения | ✅ Оригинал не изменяется |
| ❌ Непонятно что исправлено | ✅ Прозрачный процесс |

---

## 📖 Номера книг Библии (краткая таблица)

| Книга | № | Книга | № | Книга | № |
|-------|---|-------|---|-------|---|
| Быт | 10 | Пс | 230 | Мф | 470 |
| Исх | 20 | Притч | 240 | Мк | 480 |
| Лев | 30 | Еккл | 250 | Лк | 490 |
| Числ | 40 | Песн | 260 | Ин | 500 |
| Втор | 50 | Ис | 290 | Деян | 510 |
| **Нав** | **60** | Иер | 300 | Рим | 520 |
| Суд | 70 | Иез | 330 | 1 Кор | 530 |

*Полная таблица в BIBLE_LINK_VALIDATOR.md*

---

## ⚠️ Важные замечания

1. **autoApply: false** по умолчанию - требует ручной проверки
2. **autoApply: true** - применяется автоматически при `npm run apply`
3. **SS+.json** не изменяется - оригинал всегда сохраняется
4. **SS-valid.json** создается заново при каждом `npm run apply`
5. **bibleLinksCorrections.json** - накопительная база знаний

---

## 🆘 Troubleshooting

### Исправление не применяется

**Проверьте:**
- ✅ `autoApply: true` установлен
- ✅ Поле `from` совпадает точно с текстом
- ✅ `lessonId` и `contentId` правильные

### Ошибка в данных ссылки

**Проверьте:**
- ✅ `bookNumber` соответствует таблице
- ✅ `chapter` - массив чисел
- ✅ `verses` - массив чисел или `null`

### Слишком много шаблонов

**Решение:**
- Установите `autoApply: false` для неуверенных случаев
- Обработайте по частям (по 5-10 исправлений)

---

## 📚 Дополнительная документация

- **BIBLE_LINK_VALIDATOR.md** - Полная техническая документация
- **QUICK_START.md** - Быстрый старт
- **EXAMPLE_USAGE.md** - Примеры использования
- **VALIDATOR_README.md** - Общий обзор системы
